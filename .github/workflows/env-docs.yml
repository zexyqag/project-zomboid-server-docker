name: Generate Env Docs

on:
  workflow_run:
    workflows:
      - Build and Publish Docker Image
    types:
      - completed
  workflow_dispatch:
    inputs:
      env_docs_tag:
        description: "Optional: generate env docs for a single image tag (e.g., stable-41.78.16)"
        required: false
        default: ""
      env_docs_tags:
        description: "Optional: generate env docs for multiple tags (comma-separated)"
        required: false
        default: ""

jobs:
  prepare:
    if: (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') || (github.event_name == 'workflow_dispatch' && (inputs.env_docs_tag != '' || inputs.env_docs_tags != ''))
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_tags: ${{ steps.set-matrix.outputs.has_tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Build tag matrix
        id: set-matrix
        run: |
          set -euo pipefail
          tags=()
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            chmod +x scripts/get_latest_versions.sh
            eval "$(scripts/get_latest_versions.sh)"
            tags+=("stable-${LATEST_STABLE_VERSION}")
            tags+=("unstable-${LATEST_UNSTABLE_VERSION}")
          else
            if [ -n "${{ inputs.env_docs_tag }}" ]; then
              tags+=("${{ inputs.env_docs_tag }}")
            fi
            if [ -n "${{ inputs.env_docs_tags }}" ]; then
              IFS=',' read -ra raw_tags <<< "${{ inputs.env_docs_tags }}"
              for raw_tag in "${raw_tags[@]}"; do
                tag="$(echo "$raw_tag" | xargs)"
                [ -z "$tag" ] && continue
                tags+=("$tag")
              done
            fi
          fi

          matrix=$(printf '%s\n' "${tags[@]}" | jq -R -s '
            split("\n")
            | map(select(length>0) | {tag:., safe:(gsub("[^A-Za-z0-9_.-]"; "_"))})
          ')
          if [ "${#tags[@]}" -eq 0 ]; then
            echo "has_tags=false" >> "$GITHUB_OUTPUT"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
          else
            echo "has_tags=true" >> "$GITHUB_OUTPUT"
            {
              echo "matrix<<EOF"
              echo "$matrix"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

  generate:
    needs: prepare
    if: needs.prepare.outputs.has_tags == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set lowercase repository name
        run: |
          REPO_NAME=${{ github.repository }}
          echo "REPO_NAME_LC=${REPO_NAME,,}" >>${GITHUB_ENV}

      - name: Prepare env sources
        run: |
          TAG="${{ matrix.tag }}"
          TAG_SAFE="${{ matrix.safe }}"
          TAG_DIR="docs/env_sources/${TAG_SAFE}"
          echo "TAG=${TAG}" >> ${GITHUB_ENV}
          echo "TAG_SAFE=${TAG_SAFE}" >> ${GITHUB_ENV}
          echo "TAG_DIR=${TAG_DIR}" >> ${GITHUB_ENV}
          sudo rm -rf "${TAG_DIR}"
          mkdir -p "${TAG_DIR}"

      - name: Pull image
        run: |
          docker pull ghcr.io/${REPO_NAME_LC}:${TAG}

      - name: Extract env sources
        run: |
          docker run --rm --entrypoint /server/scripts/extract_env_sources.sh \
            -v "$PWD/${TAG_DIR}:/out" \
            ghcr.io/${REPO_NAME_LC}:${TAG} /out

      - name: Generate INI sources
        run: |
          sudo rm -rf "${TAG_DIR}/zomboid"
          mkdir -p "${TAG_DIR}/zomboid"
          docker rm -f "pz-envdocs-${TAG_SAFE}" >/dev/null 2>&1 || true
          CID=$(docker run -d --name "pz-envdocs-${TAG_SAFE}" \
            -e ADMINPASSWORD=envdocs \
            -e SERVERNAME=envdocs \
            -v "$PWD/${TAG_DIR}/zomboid:/home/steam/Zomboid" \
            ghcr.io/${REPO_NAME_LC}:${TAG})
          INI_PATH="${TAG_DIR}/zomboid/Server/envdocs.ini"
          for i in {1..120}; do
            if [ -f "$INI_PATH" ]; then
              break
            fi
            sleep 2
          done
          docker stop "$CID" >/dev/null 2>&1 || true
          docker rm -f "$CID" >/dev/null 2>&1 || true
          sudo chown -R "$(id -u):$(id -g)" "${TAG_DIR}"
          if [ ! -f "$INI_PATH" ]; then
            echo "Warning: INI file not created for $TAG" >&2
          fi

      - name: Generate env docs
        run: |
          mkdir -p docs/env
          ENV_SOURCES_DIR="${TAG_DIR}" OUTPUT_PATH="docs/env/${TAG}.json" IMAGE_TAG="${TAG}" bash scripts/generate_env_docs.sh

      - name: Upload env docs
        uses: actions/upload-artifact@v3
        with:
          name: env-docs-${{ matrix.safe }}
          path: docs/env/${{ matrix.tag }}.json

  commit:
    needs: [prepare, generate]
    if: needs.prepare.outputs.has_tags == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download env docs
        uses: actions/download-artifact@v3
        with:
          path: ./env-docs

      - name: Stage env docs
        run: |
          mkdir -p docs/env
          find ./env-docs -type f -name '*.json' -exec cp -f {} docs/env/ \;

      - name: Commit and push docs branch
        run: |
          git add docs/env

          if git diff --cached --quiet; then
            echo "No env docs changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          tmp_dir="$(mktemp -d)"
          cp -r docs/env "$tmp_dir/env"

          git checkout --orphan docs/env
          git rm -rf .
          mkdir -p docs
          cp -r "$tmp_dir/env" docs/env
          git add docs/env
          git commit -m "chore: update env docs"
          git push --force origin docs/env
