name: Generate Env Docs

on:
  workflow_run:
    workflows:
      - Build and Publish Docker Image
    types:
      - completed
  workflow_dispatch:
    inputs:
      env_docs_tag:
        description: "Optional: generate env docs for a single image tag (e.g., stable-41.78.16)"
        required: false
        default: ""
      env_docs_tags:
        description: "Optional: generate env docs for multiple tags (comma-separated)"
        required: false
        default: ""

jobs:
  env_docs_push:
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set lowercase repository name
        run: |
          REPO_NAME=${{ github.repository }}
          echo "REPO_NAME_LC=${REPO_NAME,,}" >>${GITHUB_ENV}

      - name: Get latest Project Zomboid versions
        run: |
          chmod +x scripts/get_latest_versions.sh
          scripts/get_latest_versions.sh >> ${GITHUB_ENV}

      - name: Extract env sources and generate docs (stable)
        run: |
          TAG="stable-${LATEST_STABLE_VERSION}"
          sudo rm -rf docs/env_sources/stable
          mkdir -p docs/env_sources/stable
          docker pull ghcr.io/${REPO_NAME_LC}:${TAG}
          docker run --rm --entrypoint /server/scripts/extract_env_sources.sh -v "$PWD/docs/env_sources/stable:/out" ghcr.io/${REPO_NAME_LC}:${TAG} /out
          sudo rm -rf docs/env_sources/stable/zomboid
          mkdir -p docs/env_sources/stable/zomboid
          TAG_SAFE="${TAG//[^a-zA-Z0-9_.-]/_}"
          CID=$(docker run -d --name "pz-envdocs-${TAG_SAFE}" \
            -e ADMINPASSWORD=envdocs \
            -e SERVERNAME=envdocs \
            -v "$PWD/docs/env_sources/stable/zomboid:/home/steam/Zomboid" \
            ghcr.io/${REPO_NAME_LC}:${TAG})
          INI_PATH="docs/env_sources/stable/zomboid/Server/envdocs.ini"
          for i in {1..120}; do
            if [ -f "$INI_PATH" ]; then
              break
            fi
            sleep 2
          done
          docker stop "$CID" >/dev/null 2>&1 || true
          docker rm -f "$CID" >/dev/null 2>&1 || true
          sudo chown -R "$(id -u):$(id -g)" docs/env_sources/stable
          if [ ! -f "$INI_PATH" ]; then
            echo "Warning: INI file not created for $TAG" >&2
          fi
          ENV_SOURCES_DIR="docs/env_sources/stable" OUTPUT_PATH="docs/env/${TAG}.json" IMAGE_TAG="${TAG}" python3 scripts/generate_env_docs.py

      - name: Extract env sources and generate docs (unstable)
        run: |
          TAG="unstable-${LATEST_UNSTABLE_VERSION}"
          sudo rm -rf docs/env_sources/unstable
          mkdir -p docs/env_sources/unstable
          docker pull ghcr.io/${REPO_NAME_LC}:${TAG}
          docker run --rm --entrypoint /server/scripts/extract_env_sources.sh -v "$PWD/docs/env_sources/unstable:/out" ghcr.io/${REPO_NAME_LC}:${TAG} /out
          sudo rm -rf docs/env_sources/unstable/zomboid
          mkdir -p docs/env_sources/unstable/zomboid
          TAG_SAFE="${TAG//[^a-zA-Z0-9_.-]/_}"
          CID=$(docker run -d --name "pz-envdocs-${TAG_SAFE}" \
            -e ADMINPASSWORD=envdocs \
            -e SERVERNAME=envdocs \
            -v "$PWD/docs/env_sources/unstable/zomboid:/home/steam/Zomboid" \
            ghcr.io/${REPO_NAME_LC}:${TAG})
          INI_PATH="docs/env_sources/unstable/zomboid/Server/envdocs.ini"
          for i in {1..120}; do
            if [ -f "$INI_PATH" ]; then
              break
            fi
            sleep 2
          done
          docker stop "$CID" >/dev/null 2>&1 || true
          docker rm -f "$CID" >/dev/null 2>&1 || true
          sudo chown -R "$(id -u):$(id -g)" docs/env_sources/unstable
          if [ ! -f "$INI_PATH" ]; then
            echo "Warning: INI file not created for $TAG" >&2
          fi
          ENV_SOURCES_DIR="docs/env_sources/unstable" OUTPUT_PATH="docs/env/${TAG}.json" IMAGE_TAG="${TAG}" python3 scripts/generate_env_docs.py

      - name: Commit and push docs branch
        run: |
          sudo rm -rf docs/env_sources

          git add docs/env

          if git diff --cached --quiet; then
            echo "No env docs changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          tmp_dir="$(mktemp -d)"
          cp -r docs/env "$tmp_dir/env"

          git checkout --orphan docs/env
          git rm -rf .
          mkdir -p docs
          cp -r "$tmp_dir/env" docs/env
          git add docs/env
          git commit -m "chore: update env docs"
          git push --force origin docs/env

  env_docs_manual:
    if: github.event_name == 'workflow_dispatch' && (inputs.env_docs_tag != '' || inputs.env_docs_tags != '')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set lowercase repository name
        run: |
          REPO_NAME=${{ github.repository }}
          echo "REPO_NAME_LC=${REPO_NAME,,}" >>${GITHUB_ENV}

      - name: Extract env sources and generate docs (manual tag)
        if: inputs.env_docs_tag != ''
        run: |
          TAG="${{ inputs.env_docs_tag }}"
          sudo rm -rf docs/env_sources/manual
          mkdir -p docs/env_sources/manual
          docker pull ghcr.io/${REPO_NAME_LC}:${TAG}
          docker run --rm --entrypoint /server/scripts/extract_env_sources.sh -v "$PWD/docs/env_sources/manual:/out" ghcr.io/${REPO_NAME_LC}:${TAG} /out
          sudo rm -rf docs/env_sources/manual/zomboid
          mkdir -p docs/env_sources/manual/zomboid
          TAG_SAFE="${TAG//[^a-zA-Z0-9_.-]/_}"
          CID=$(docker run -d --name "pz-envdocs-${TAG_SAFE}" \
            -e ADMINPASSWORD=envdocs \
            -e SERVERNAME=envdocs \
            -v "$PWD/docs/env_sources/manual/zomboid:/home/steam/Zomboid" \
            ghcr.io/${REPO_NAME_LC}:${TAG})
          INI_PATH="docs/env_sources/manual/zomboid/Server/envdocs.ini"
          for i in {1..120}; do
            if [ -f "$INI_PATH" ]; then
              break
            fi
            sleep 2
          done
          docker stop "$CID" >/dev/null 2>&1 || true
          docker rm -f "$CID" >/dev/null 2>&1 || true
          sudo chown -R "$(id -u):$(id -g)" docs/env_sources/manual
          if [ ! -f "$INI_PATH" ]; then
            echo "Warning: INI file not created for $TAG" >&2
          fi
          ENV_SOURCES_DIR="docs/env_sources/manual" OUTPUT_PATH="docs/env/${TAG}.json" IMAGE_TAG="${TAG}" python3 scripts/generate_env_docs.py

      - name: Extract env sources and generate docs (manual tags)
        if: inputs.env_docs_tags != ''
        run: |
          sudo rm -rf docs/env_sources/manual
          mkdir -p docs/env_sources/manual

          IFS=',' read -ra TAGS <<< "${{ inputs.env_docs_tags }}"
          for raw_tag in "${TAGS[@]}"; do
            TAG="$(echo "$raw_tag" | xargs)"
            [ -z "$TAG" ] && continue
            TAG_DIR="docs/env_sources/manual/${TAG//\//_}"
            sudo rm -rf "$TAG_DIR"
            mkdir -p "$TAG_DIR"
            docker pull ghcr.io/${REPO_NAME_LC}:${TAG}
            docker run --rm --entrypoint /server/scripts/extract_env_sources.sh -v "$PWD/$TAG_DIR:/out" ghcr.io/${REPO_NAME_LC}:${TAG} /out
            sudo rm -rf "$TAG_DIR/zomboid"
            mkdir -p "$TAG_DIR/zomboid"
            TAG_SAFE="${TAG//[^a-zA-Z0-9_.-]/_}"
            CID=$(docker run -d --name "pz-envdocs-${TAG_SAFE}" \
              -e ADMINPASSWORD=envdocs \
              -e SERVERNAME=envdocs \
              -v "$PWD/$TAG_DIR/zomboid:/home/steam/Zomboid" \
              ghcr.io/${REPO_NAME_LC}:${TAG})
            INI_PATH="$TAG_DIR/zomboid/Server/envdocs.ini"
            for i in {1..120}; do
              if [ -f "$INI_PATH" ]; then
                break
              fi
              sleep 2
            done
            docker stop "$CID" >/dev/null 2>&1 || true
            docker rm -f "$CID" >/dev/null 2>&1 || true
            sudo chown -R "$(id -u):$(id -g)" "$TAG_DIR"
            if [ ! -f "$INI_PATH" ]; then
              echo "Warning: INI file not created for $TAG" >&2
            fi
            ENV_SOURCES_DIR="$TAG_DIR" OUTPUT_PATH="docs/env/${TAG}.json" IMAGE_TAG="${TAG}" python3 scripts/generate_env_docs.py
          done

      - name: Commit and push docs branch
        run: |
          sudo rm -rf docs/env_sources

          git add docs/env

          if git diff --cached --quiet; then
            echo "No env docs changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          tmp_dir="$(mktemp -d)"
          cp -r docs/env "$tmp_dir/env"

          git checkout --orphan docs/env
          git rm -rf .
          mkdir -p docs
          cp -r "$tmp_dir/env" docs/env
          git add docs/env
          git commit -m "chore: update env docs"
          git push --force origin docs/env
